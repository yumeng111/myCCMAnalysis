pmt_id_to_position_mapping = dict([
 ('FB0784', 'C101R0'),
 ('FB0792', 'C401R0'),
 ('FB0831', 'C105R0'),
 ('FB0791', 'C210R0'),
 ('FB0790', 'C201R0'),
 ('FB0783', 'C103R0'),
 ('FB0793', 'C315R0'),
 ('FB0787', 'C301R0'),
 ('FB0835', 'C102R0'),
 ('FB0789', 'C314R0'),
 ('FB0796', 'C419R0'),
 ('FB0797', 'C313R0'),
 ('FB0788', 'C209R0'),
 ('FB0728', 'C417R0'),
 ('FB0827', 'C104R0'),
 ('FB0692', 'C312R0'),
 ('FB0707', 'C207R0'),
 ('FB0778', 'C208R0'),
 ('FB0785', 'C415R0'),
 ('FB0698', 'C311R0'),
 ('FB0703', 'C302R0'),
 ('FB0718', 'C305R0'),
 ('FB0706', 'C303R0'),
 ('FB0723', 'C204R0'),
 ('FB0716', 'C306R0'),
 ('FB0780', 'C405R0'),
 ('FB0708', 'C304R0'),
 ('FB0711', 'C403R0'),
 ('FB0833', 'C202R0'),
 ('FB0779', 'C203R0'),
 ('FB0667', 'C407R0'),
 ('FB0665', 'C307R0'),
 ('FB0715', 'C205R0'),
 ('FB0721', 'C409R0'),
 ('FB0782', 'C308R0'),
 ('FB0668', 'C309R0'),
 ('FB0663', 'C411R0'),
 ('FB0671', 'C206R0'),
 ('FB0794', 'C310R0'),
 ('FB0839', 'C413R0'),
 ('FB0795', 'C2R3'),
 ('FB0830', 'C2R4'),
 ('FB0836', 'C2R2'),
 ('FB0852', 'C2R5'),
 ('FB0786', 'C2R1'),
 ('FB0832', 'C1R3'),
 ('FB0838', 'C1R4'),
 ('FB0834', 'C1R5'),
 ('FB0837', 'C1R1'),
 ('FB0687', 'C1R2'),
 ('FB0777', 'C3R3'),
 ('FB0695', 'C3R5'),
 ('FB0775', 'C3R1'),
 ('FB0846', 'C3R4'),
 ('FB0803', 'C3R2'),
 ('FB0680', 'C5R2'),
 ('FB0709', 'C5R5'),
 ('FB0851', 'C5R1'),
 ('FB0727', 'C5R4'),
 ('FB0712', 'C5R3'),
 ('FB0696', 'C24R5'),
 ('FB0674', 'C24R2'),
 ('FB0853', 'C24R4'),
 ('FB0731', 'C24R1'),
 ('FB0705', 'C24R3'),
 ('FB0772', 'C23R4'),
 ('FB0773', 'C23R3'),
 ('FB0768', 'C23R1'),
 ('FB0855', 'C23R2'),
 ('FB0845', 'C23R5'),
 ('FB0713', 'C4R5'),
 ('FB0681', 'C4R3'),
 ('FB0798', 'C4R4'),
 ('FB0774', 'C4R2'),
 ('FB0771', 'C4R1'),
 ('FB0766', 'C8R1'),
 ('FB0729', 'C8R5'),
 ('FB0807', 'C8R4'),
 ('FB0676', 'C8R3'),
 ('FB0679', 'C8R2'),
 ('FB0724', 'C10R1'),
 ('FB0673', 'C9R4'),
 ('FB0677', 'C9R5'),
 ('FB0678', 'C9R2'),
 ('FB0808', 'C10R3'),
 ('FB0813', 'C10R2'),
 ('FB0802', 'C10R5'),
 ('FB0675', 'C9R3'),
 ('FB0804', 'C9R1'),
 ('FB0815', 'C10R4'),
 ('FB0840', 'C11R1'),
 ('FB0809', 'C11R3'),
 ('FB0799', 'C11R2'),
 ('FB0776', 'C11R4'),
 ('FB0844', 'C11R5'),
 ('FB0812', 'C13R5'),
 ('FB0841', 'C12R1'),
 ('FB0842', 'C12R3'),
 ('FB0849', 'C12R2'),
 ('FB0800', 'C13R1'),
 ('FB0848', 'C13R2'),
 ('FB0847', 'C13R4'),
 ('FB0769', 'C12R5'),
 ('FB0805', 'C12R4'),
 ('FB0843', 'C13R3'),
 ('FB0810', 'C14R1'),
 ('FB0816', 'C14R2'),
 ('FB0806', 'C14R5'),
 ('FB0814', 'C14R4'),
 ('FB0739', 'C14R3'),
 ('FB0736', 'C15R3'),
 ('FB0801', 'C15R2'),
 ('FB0738', 'C15R1'),
 ('FB0743', 'C15R4'),
 ('FB0662', 'C15R5'),
 ('FB0664', 'C16R3'),
 ('FB0714', 'C16R2'),
 ('FB07122', 'C16R5'),
 ('FB0761', 'C16R4'),
 ('FB0666', 'C16R1'),
 ('FB0620', 'C19R1'),
 ('FB0719', 'C19R5'),
 ('FB0717', 'C19R4'),
 ('FB0749', 'C19R2'),
 ('FB0720', 'C19R3'),
 ('FB0735', 'C20R1'),
 ('FB0669', 'C20R2'),
 ('FB0734', 'C20R5'),
 ('FB0762', 'C20R4'),
 ('FB0737', 'C20R3'),
 ('FB0741', 'C21R3'),
 ('FB0811', 'C21R4'),
 ('FB0817', 'C21R5'),
 ('FB0701', 'C21R2'),
 ('FB0757', 'C21R1'),
 ('FB0616', 'C22R2'),
 ('FB0617', 'C22R4'),
 ('FB0619', 'C22R1'),
 ('FB0740', 'C22R3'),
 ('FB0759', 'C22R5'),
 ('FB0825', 'C18R2'),
 ('FB0672', 'C18R1'),
 ('FB0730', 'C18R4'),
 ('FB0732', 'C17R3'),
 ('FB0820', 'C18R3'),
 ('FB0821', 'C17R2'),
 ('FB0818', 'C17R5'),
 ('FB0748', 'C18R5'),
 ('FB0726', 'C17R4'),
 ('FB0763', 'C17R1'),
 ('FB0618', 'C6R4'),
 ('FB0744', 'C6R5'),
 ('FB0612', 'C6R2'),
 ('FB0755', 'C7R2'),
 ('FB0472', 'C7R3'),
 ('FB0469', 'C6R3'),
 ('FB0613', 'C7R4'),
 ('FB0620', 'C6R1'),
 ('FB0614', 'C7R5'),
 ('FB0482', 'C7R1'),
 ('FB0694', 'C410R6'),
 ('FB0628', 'C308R6'),
 ('FB0690', 'C206R6'),
 ('FB0691', 'C309R6'),
 ('FB0747', 'C412R6'),
 ('FB0765', 'C310R6'),
 ('FB0682', 'C207R6'),
 ('FB0688', 'C416R6'),
 ('FB0824', 'C313R6'),
 ('FB0828', 'C209R6'),
 ('FB0686', 'C208R6'),
 ('FB0684', 'C312R6'),
 ('FB0688', 'C311R6'),
 ('FB0829', 'C105R6'),
 ('FB0750', 'C104R6'),
 ('FB0699', 'C101R6'),
 ('FB0685', 'C314R6'),
 ('FB0756', 'C418R6'),
 ('FB0693', 'C414R6'),
 ('FB0700', 'C315R6'),
 ('FB0781', 'C210R6'),
 ('FB0733', 'C420R6'),
 ('FB0697', 'C201R6'),
 ('FB0683', 'C301R6'),
 ('FB0651', 'C202R6'),
 ('FB0588', 'C404R6'),
 ('FB0645', 'C303R6'),
 ('FB0597', 'C302R6'),
 ('FB0526', 'C402R6'),
 ('FB0636', 'C203R6'),
 ('FB0584', 'C304R6'),
 ('FB0626', 'C102R6'),
 ('FB0691', 'C103R6'),
 ('FB0468', 'C307R6'),
 ('FB0819', 'C204R6'),
 ('FB0615', 'C406R6'),
 ('FB0755', 'C205R6'),
 ('FB0850', 'C408R6'),
 ('FB0440', 'C306R6'),
 ('FB0471', 'C305R6'),
 ('V15', 'VCB10'),
 ('V29', 'VT10'),
 ('V34', 'VCB6'),
 ('V11', 'VCT9'),
 ('V33', 'VCB12'),
 ('V27', 'VCT11'),
 ('V28', 'VCT13'),
 ('V8', 'VT12'),
 ('V28', 'VCB2'),
 ('V6', 'VCT7'),
 ('V16', 'VCT15'),
 ('V31', 'VT18'),
 ('V25', 'VT14'),
 ('V30', 'VT16'),
 ('V36', 'VT4'),
 ('V35', 'VT6'),
 ('V16', 'VCT17'),
 ('V30', 'VT20'),
 ('V5', 'VCT19'),
 ('V14', 'VCT21'),
 ('V10', 'VCT5'),
 ('V12', 'VCT3'),
 ('V13', 'VCT1'),
 ('V2', 'VCT23'),
 ('V37', 'VT24'),
 ('V38', 'VT22'),
 ('V41', 'VCB20'),
 ('V39', 'VCB18'),
 ('V128', 'VB9'),
 ('V44', 'VB23'),
 ('V127', 'VCB24'),
 ('V88', 'VT2'),
 ('V129', 'VCB22'),
 ('VU', 'VB17'),
 ('VS', 'VB15'),
 ('V55', 'VB13'),
 ('V-Omega', 'VB1'),
 ('V125', 'VCB4'),
 ('V126', 'VB5')])

def merge(files, output_file, geometry_output_file):
    import glob
    print("Glob", files)
    fnames = [[s for g in l for s in glob.glob(g)] for l in files]
    print("Found these files:")
    for s in fnames:
        print(s)
    # exit(1)

    import I3Tray
    from icecube import icetray
    from icecube.icetray import load
    from icecube import dataclasses
    load("CCMBinary", False)
    load("daqtools", False)

    tray = I3Tray.I3Tray()
    tray.AddModule("MergedSource", "reader", FileLists=fnames, MaxTimeDiff=16)
    tray.AddModule("CCMGeometryGenerator", "geometry_generator", PMTPositionsByID=dataclasses.I3MapStringString(pmt_id_to_position_mapping), SquashDuplicateConfigs=True)
    tray.AddModule("I3Writer", "geometry_writer", FileName=geometry_output_file, Streams=[icetray.I3Frame.Geometry])
    if "%" in output_file:
        tray.AddModule("I3MultiWriter", "writer", SizeLimit=(3*1024**3), FileName=output_file, MetadataStreams=[icetray.I3Frame.Geometry, icetray.I3Frame.Calibration, icetray.I3Frame.DetectorStatus], CounterStream=icetray.I3Frame.DAQ, SizeCheckInterval=1000, NWorkers=8, Streams=[icetray.I3Frame.Calibration, icetray.I3Frame.DetectorStatus, icetray.I3Frame.DAQ, icetray.I3Frame.Physics])
    else:
        tray.AddModule("I3Writer", "writer", FileName=output_file, Streams=[icetray.I3Frame.Calibration, icetray.I3Frame.DetectorStatus, icetray.I3Frame.DAQ, icetray.I3Frame.Physics])
    tray.Execute()

if __name__ == "__main__":
    import argparse
    parser = argparse.ArgumentParser(
            prog = "Merge DAQ streams",
            description = "Merges CCM i3 files from multiple DAQs",
    )

    parser.add_argument("--files",
            type=str,
            nargs="+",
            action="append",
            default=[],
            required=True,
            help="Files to process")

    parser.add_argument("--output-file",
            type=str,
            required=True,
            help="Output file name")
    parser.add_argument("--geometry-output-file",
            type=str,
            required=True,
            help="Output file name")

    args = parser.parse_args()

    merge(args.files, args.output_file, args.geometry_output_file)

