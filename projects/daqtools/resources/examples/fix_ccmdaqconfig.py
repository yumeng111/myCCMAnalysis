#!/usr/bin/env python3
import numpy as np
from icecube.icetray import load
from I3Tray import I3Tray
from icecube import CCMBinary, icetray, dataio, dataclasses, phys_services
from icecube.icetray import I3Frame, I3Module, I3ConditionalModule
from icecube.dataclasses import CCMOMGeo
from icecube.icetray import CCMTriggerKey, CCMPMTKey
load("CCMBinary", False)

class FixCCMDAQConfig(I3ConditionalModule):
    def __init__(self, context):
        I3ConditionalModule.__init__(self, context)
        self.maping_data = [
			['14', '6', 'FB0779', 'C203R0', 'U', '3'],
			['14', '4', 'FB0765', 'C310R6', 'U', '3'],
			['15', '3', 'FB0755', 'C205R6', 'U', '3'],
			['16', '11', 'FB0782', 'C308R0', 'U', '3'],
			['15', '6', 'FB0747', 'C408R6', 'U', '3'],
			['16', '1', 'FB0780', 'C405R0', 'U', '3'],
			['16', '10', 'FB0626', 'C102R6', 'U', '3'],
			['15', '8', 'FB0796', 'C419R0', '0', '3'],
			['14', '10', 'FB0768', 'C23R1', '0', '3'],
			['14', '8', 'FB0471', 'C305R6', '0', '3'],
			['2', '10', 'FB06911', 'C103R6', '0', '2'],
			['11', '6', 'FB0584', 'C304R6', '0', '3'],
			['15', '2', 'FB0706', 'C303R0', '0', '3'],
			['15', '11', 'FB0671', 'C206R0', '0', '3'],
			['2', '5', 'FB0828', 'C209R6', '0', '3'],
			['4', '1', 'FB0686', 'C208R6', '0', '3'],
			['3', '6', 'FB0684', 'C312R6', '0', '3'],
			['14', '9', 'FB0699', 'C101R6', '0', '3'],
			['9', '7', 'FB0705', 'C24R3', '0', '3'],
			['14', '11', 'FB0468', 'C307R6', '0', '2'],
			['15', '14', 'FB0615', 'C406R6', '0', '3'],
			['15', '7', 'FB0708', 'C304R0', '0', '3'],
			['15', '12', 'FB0718', 'C305R0', '0', '3'],
			['15', '13', 'FB0703', 'C302R0', '0', '3'],
			['9', '6', 'FB0839', 'C413R0', '0', '3'],
			['16', '7', 'FB0824', 'C313R6', '0', '3'],
			['16', '6', 'FB0688', 'C311R6', '0', '3'],
			['15', '0', 'FB0733', 'C420R6', '0', '3'],
			['14', '14', 'FB0651', 'C202R6', '0', '2'],
			['15', '4', 'FB0731', 'C24R1', '0', '3'],
			['14', '13', 'FB0819', 'C204R6', '0', '3'],
			['15', '10', 'FB0711', 'C403R0', '0', '3'],
			['15', '9', 'FB0716', 'C306R0', '0', '3'],
			['7', '0', 'FB0667', 'C407R0', '0', '2'],
			['3', '7', 'FB0663', 'C411R0', '0', '3'],
			['16', '2', 'FB0689', 'C416R6', '0', '3'],
			['14', '7', 'FB0636', 'C203R6', '0', '3'],
			['15', '1', 'FB0674', 'C24R2', '0', '2'],
			['15', '5', 'FB0440', 'C306R6', '0', '3'],
			['16', '9', 'FB0833', 'C202R0', '0', '3'],
			['16', '0', 'FB0723', 'C204R0', '0', '2'],
			['14', '12', 'FB0721', 'C409R0', '0', '3'],
			['16', '8', 'FB0715', 'C205R0', '0', '3'],
			['16', '5', 'FB0665', 'C307R0', '0', '3'],
			['4', '2', 'FB0850', 'C412R6', '0', '3'],
			['18', '4', 'V126', 'VB5', '0', '1'],
			['1', '2', 'V125', 'VCB4', '0', '1'],
			['1', '3', 'V14', 'VCT21', '0', '1'],
			['1', '4', 'FB0697', 'C201R6', '0', '3'],
			['18', '2', 'V11', 'VCT9', '0', '1'],
			['1', '6', 'V29', 'VT10', '0', '1'],
			['1', '7', 'V25', 'VT14', '0', '1'],
			['1', '8', 'V36', 'VT4', '0', '1'],
			['1', '9', 'V16', 'VCT17', '0', '1'],
			['18', '0', 'VS', 'VB15', '0', '1'],
			['1', '11', 'V128', 'VB9', '0', '1'],
			['1', '13', 'V38', 'VT22', '0', '1'],
			['1', '14', 'V37', 'VT24', '0', '1'],
			['18', '1', 'V10', 'VCT5', '0', '1'],
			['2', '2', 'V28', 'VCT13', '0', '1'],
			['2', '3', 'V6', 'VCT7', '0', '1'],
			['2', '4', 'V28', 'VCB2', '0', '1'],
			['18', '3', 'V30', 'VT16', '0', '1'],
			['2', '7', 'V88', 'VT2', '0', '1'],
			['2', '8', 'VU', 'VB17', '0', '1'],
			['4', '3', 'FB0691', 'C309R6', '0', '3'],
			['4', '4', 'FB0628', 'C308R6', '0', '3'],
			['2', '11', 'V-Omega', 'VB1', '0', '1'],
			['2', '12', 'V12', 'VCT3', '0', '1'],
			['2', '13', 'V39', 'VCB18', '0', '1'],
			['2', '14', 'V34', 'VCB6', '0', '1'],
			['2', '0', 'V27', 'VCT11', '0', '1'],
			['2', '1', 'V33', 'VCB12', '0', '1'],
			['3', '2', 'V31', 'VT18', '0', '1'],
			['3', '3', 'V3', 'VT20', '0', '1'],
			['3', '4', 'V127', 'VCB24', '0', '1'],
			['3', '5', 'V44', 'VB23', '0', '1'],
			['4', '6', 'FB0694', 'C410R6', '0', '3'],
			['3', '8', 'V41', 'VCB20', '0', '1'],
			['3', '9', 'V2', 'VCT23', '0', '1'],
			['3', '10', 'V13', 'VCT1', '0', '1'],
			['3', '11', 'V55', 'VB13', '0', '1'],
			['3', '12', 'V15', 'VCB10', '0', '1'],
			['3', '13', 'V8', 'VT12', '0', '1'],
			['3', '14', 'V35', 'VT6', '0', '1'],
			['3', '0', 'V5', 'VCT19', '0', '1'],
			['18', '5', 'V16', 'VCT15', '0', '1'],
			['5', '1', 'FB0778', 'C208R0', 'U', '3'],
			['18', '8', 'FB0763', 'C17R1', 'U', '3'],
			['4', '9', 'FB0645', 'C303R6', 'U', '3'],
			['4', '10', 'FB0756', 'C418R6', 'U', '3'],
			['5', '4', 'FB0785', 'C415R0', 'U', '3'],
			['6', '9', 'FB0799', 'C11R2', 'U', '3'],
			['6', '10', 'FB0800', 'C13R1', 'U', '3'],
			['6', '12', 'FB0753', 'C7R2', 'U', '3'],
			['18', '9', 'FB0748', 'C18R5', 'U', '3'],
			['4', '0', 'FB0781', 'C210R6', 'U', '3'],
			['7', '10', 'FB0744', 'C6R5', 'U', '3'],
			['4', '7', 'FB0588', 'C404R6', '0', '2'],
			['4', '8', 'FB0685', 'C314R6', '0', '2'],
			['5', '2', 'FB0797', 'C313R0', '0', '3'],
			['6', '1', 'FB0812', 'C13R5', '0', '3'],
			['6', '2', 'FB0844', 'C11R5', '0', '2'],
			['6', '3', 'FB0840', 'C11R1', '0', '3'],
			['6', '4', 'FB0472', 'C7R3', '0', '3'],
			['6', '5', 'FB0612', 'C6R2', '0', '3'],
			['6', '6', 'FB0730', 'C18R4', '0', '3'],
			['6', '7', 'FB0820', 'C18R3', '0', '3'],
			['5', '3', 'FB0707', 'C207R0', '0', '3'],
			['5', '5', 'FB0728', 'C417R0', '0', '2'],
			['6', '11', 'FB0618', 'C6R4', '0', '3'],
			['18', '6', 'FB0818', 'C17R5', '0', '3'],
			['6', '14', 'FB0825', 'C18R2', '0', '3'],
			['6', '0', 'FB0821', 'C17R2', '0', '3'],
			['4', '11', 'FB0526', 'C402R6', '0', '3'],
			['5', '6', 'FB0827', 'C104R0', '0', '2'],
			['5', '7', 'FB0788', 'C209R0', '0', '2'],
			['5', '8', 'FB0692', 'C312R0', '0', '3'],
			['18', '7', 'FB0849', 'C12R2', '0', '2'],
			['7', '2', 'FB0841', 'C12R1', '0', '3'],
			['7', '1', 'FB0614', 'C7R5', '0', '2'],
			['7', '4', 'FB0469', 'C6R3', '0', '3'],
			['7', '5', 'FB0482', 'C7R1', '0', '3'],
			['7', '7', 'FB0672', 'C18R1', '0', '2'],
			['4', '13', 'FB0597', 'C302R6', '0', '3'],
			['4', '14', 'FB0683', 'C301R6', '0', '3'],
			['5', '9', 'FB0789', 'C314R0', '0', '3'],
			['5', '10', 'FB0698', 'C311R0', '0', '3'],
			['7', '8', 'FB0842', 'C12R3', '0', '3'],
			['7', '9', 'FB0809', 'C11R3', '0', '3'],
			['7', '11', 'FB0613', 'C7R4', '0', '3'],
			['7', '12', 'FB0620', 'C6R1', '0', '2'],
			['7', '13', 'FB0726', 'C17R4', '0', '2'],
			['7', '14', 'FB0732', 'C17R3', '0', '3'],
			['8', '8', 'FB0759', 'C22R5', 'U', '3'],
			['8', '11', 'FB0762', 'C20R4', 'U', '3'],
			['8', '14', 'FB0801', 'C15R2', 'U', '3'],
			['9', '1', 'FB0805', 'C12R4', 'U', '3'],
			['9', '3', 'FB0798', 'C4R4', 'U', '3'],
			['10', '6', 'FB0619', 'C22R1', '0', '2'],
			['10', '7', 'FB0749', 'C19R2', 'U', '3'],
			['10', '10', 'FB0761', 'C16R4', 'U', '3'],
			['10', '12', 'FB0806', 'C14R5', 'U', '3'],
			['11', '3', 'FB0757', 'C21R1', 'U', '3'],
			['18', '10', 'FB0738', 'C15R1', '0', '3'],
			['8', '2', 'FB0714', 'C16R2', '0', '2'],
			['8', '3', 'FB0847', 'C13R4', '0', '2'],
			['8', '4', 'FB0739', 'C14R3', '0', '3'],
			['8', '5', 'FB0843', 'C13R3', '0', '3'],
			['8', '6', 'FB0776', 'C11R4', '0', '3'],
			['8', '7', 'FB0771', 'C4R1', '0', '3'],
			['8', '9', 'FB0616', 'C22R2', '0', '3'],
			['8', '10', 'FB0717', 'C19R4', '0', '3'],
			['8', '12', 'FB0735', 'C20R1', '0', '3'],
			['8', '13', 'FB0666', 'C16R1', '0', '3'],
			['8', '0', 'FB0814', 'C14R4', '0', '3'],
			['9', '2', 'FB0848', 'C13R2', '0', '3'],
			['9', '4', 'FB0774', 'C4R2', '0', '2'],
			['9', '5', 'FB0817', 'C21R5', '0', '3'],
			['9', '8', 'FB0701', 'C21R2', '0', '3'],
			['9', '9', 'FB0719', 'C19R5', '0', '2'],
			['9', '10', 'FB0720', 'C19R3', '0', '3'],
			['9', '11', 'FB0669', 'C20R2', '0', '2'],
			['9', '12', 'FB0722', 'C16R5', '0', '3'],
			['9', '13', 'FB0662', 'C15R5', '0', '2'],
			['9', '14', 'FB0664', 'C16R3', '0', '3'],
			['9', '0', 'FB0769', 'C12R5', '0', '3'],
			['10', '1', 'FB0816', 'C14R2', '0', '3'],
			['10', '2', 'FB0766', 'C8R1', '0', '3'],
			['10', '3', 'FB0681', 'C4R3', '0', '3'],
			['10', '4', 'FB0741', 'C21R3', '0', '3'],
			['10', '5', 'FB0811', 'C21R4', '0', '2'],
			['10', '8', 'FB0737', 'C20R3', '0', '3'],
			['10', '9', 'FB0743', 'C15R4', '0', '3'],
			['10', '11', 'FB0736', 'C15R3', '0', '3'],
			['10', '13', 'FB0810', 'C14R1', '0', '2'],
			['10', '14', 'FB0679', 'C8R2', '0', '2'],
			['10', '0', 'FB0713', 'C4R5', '0', '3'],
			['11', '1', 'FB0740', 'C22R3', '0', '3'],
			['11', '2', 'FB0617', 'C22R4', '0', '3'],
			['11', '4', 'FB0670', 'C19R1', '0', '3'],
			['11', '5', 'FB0734', 'C20R5', '0', '3'],
			['5', '11', 'FB0783', 'C103R0', 'U', '3'],
			['11', '8', 'FB0784', 'C101R0', 'U', '2'],
			['11', '11', 'FB0807', 'C8R4', 'U', '3'],
			['11', '13', 'FB0852', 'C2R5', 'U', '3'],
			['11', '14', 'FB0834', 'C1R5', 'U', '3'],
			['11', '0', 'FB0802', 'C10R5', 'U', '3'],
			['12', '4', 'FB0855', 'C23R2', 'U', '3'],
			['12', '13', 'FB0804', 'C9R1', 'U', '3'],
			['12', '14', 'FB0787', 'C301R0', 'U', '2'],
			['13', '3', 'FB0851', 'C5R1', 'U', '3'],
			['13', '5', 'FB0837', 'C1R1', '0', '3'],
			['13', '9', 'FB0853', 'C24R4', 'U', '3'],
			['13', '12', 'FB0803', 'C3R2', 'U', '3'],
			['11', '7', 'FB0831', 'C105R0', '0', '3'],
			['11', '9', 'FB0696', 'C24R5', '0', '3'],
			['11', '10', 'FB0846', 'C3R4', '0', '3'],
			['11', '12', 'FB0676', 'C8R3', '0', '3'],
			['12', '1', 'FB0808', 'C10R3', '0', '3'],
			['12', '2', 'FB0673', 'C9R4', '0', '2'],
			['5', '12', 'FB0835', 'C102R0', '0', '3'],
			['12', '3', 'FB0792', 'C401R0', '0', '3'],
			['12', '5', 'FB0772', 'C23R4', '0', '3'],
			['12', '6', 'FB0727', 'C5R4', '0', '2'],
			['12', '7', 'FB0680', 'C5R2', '0', '3'],
			['12', '8', 'FB0729', 'C8R5', '0', '3'],
			['12', '9', 'FB0830', 'C2R4', '0', '3'],
			['12', '10', 'FB0795', 'C2R3', '0', '3'],
			['12', '11', 'FB0815', 'C10R4', '0', '3'],
			['12', '12', 'FB0813', 'C10R2', '0', '3'],
			['5', '13', 'FB0790', 'C201R0', '0', '3'],
			['12', '0', 'FB0773', 'C23R3', '0', '3'],
			['13', '0', 'FB0845', 'C23R5', '0', '2'],
			['13', '1', 'FB0709', 'C5R5', '0', '3'],
			['13', '2', 'FB0712', 'C5R3', '0', '3'],
			['18', '13', 'FB0838', 'C1R4', '0', '2'],
			['13', '6', 'FB0786', 'C2R1', '0', '2'],
			['18', '11', 'FB0724', 'C10R1', '0', '2'],
			['13', '8', 'FB0678', 'C9R2', '0', '3'],
			['5', '14', 'FB0791', 'C210R0', '0', '3'],
			['5', '0', 'FB0793', 'C315R0', '0', '3'],
			['13', '10', 'FB0695', 'C3R5', '0', '2'],
			['18', '14', 'FB0777', 'C3R3', '0', '3'],
			['13', '13', 'FB0775', 'C3R1', '0', '3'],
			['18', '12', 'FB0832', 'C1R3', '0', '3'],
			['14', '0', 'FB0687', 'C1R2', '0', '3'],
			['14', '1', 'FB0836', 'C2R2', '0', '3'],
			['14', '2', 'FB0677', 'C9R5', '0', '3'],
			['14', '3', 'FB0675', 'C9R3', '0', '3'],
			['16', '14', 'FB0750', 'C104R6', 'U', '2'],
			['16', '12', 'FB0794', 'C310R0', '0', '3'],
			['16', '4', 'FB0700', 'C315R6', '0', '3'],
			['16', '3', 'FB0668', 'C309R0', '0', '3'],
			['16', '13', 'FB0829', 'C105R6', '0', '3'],
			['14', '5', 'FB0693', 'C414R6', '0', '2'],
			['3', '1', 'FB0682', 'C207R6', '0', '3'],
			['4', '5', 'FB0690', 'C206R6', '0', '3'],
			['2', '9', 'V129', 'VCB22', '0', '1'],
		]
		board_numbers = [int(x) for x in self.mapping_data[:,0]]
		channel_numbers = [int(x) for x in self.mapping_data[:, 1]]
		board_pos = self.mapping_data[:, 3]

		coated = [1 if x == "0" else (0 if x == "U" else None) for x in self.mapping_data[:, 4]]
		channel_types = [["PMT 8in coated", "PMT 8in uncoated", "PMT 1in"][0 if (x in ["2", "3"] and c) else (1 if (x in ["2", "3"] and not c) else (2 if x == "1" else None))]for x, c in zip(self.mapping_data[:, 5], coated)]

		self.board_pos_map = dict()
		for i in range(len(self.mapping_data)):
			self.board_pos_map[(board_numbers[i], channel_numbers[i])] = board_pos[i], channel_types[i]

    def Configure(self):
        pass

    def Geometry(self, frame):
        config = frame["CCMDAQConfig"]
        for board_idx in range(len(config.digitizer_boards)):
            for channel_idx in range(len(config.digitizer_boards[board_idx].channels)):
                channel = config.digitizer_boards[board_idx].channels[channel_idx]
                board_name = channel.physical_board_id
                board_number = int(str(board_name).split("physical_board_")[-1])
                if channel_idx == 15:
                    channel.physical_channel_id = "Trigger Copy %d" % board_number
                    channel.physical_channel_type = "Trigger Copy"
                    continue
                if board_number == 17:
                    print(channel.physical_board_id, channel_idx, channel.physical_channel_type, channel.physical_channel_type)
                    continue
                key = (board_number, channel_idx)
                if key not in board_pos_map:
                    channel.physical_channel_id = ""
                    channel.physical_channel_type = ""
                else:
                    pos, channel_type = board_pos_map[(board_number, channel_idx)]
                    channel.physical_channel_id = pos
                    channel.physical_channel_type = channel_type
        frame["CCMDAQConfig"] = config
        self.PushFrame(frame)

    def Finish(self):
        pass
